<!--
Todo-List

TODO onclick country: filter the events and display only the events of this country
TODO import and display peace treaties
TODO timeline on the bottom
TODO color switch smooth transition
TODO extra: double click -> show induvidual events inside country
TODO extra: zoom
DONE fix the way conflicts are displayed in the info panel: Some are displayed more than once
DONE scrollable div
DONE info pannel on the right
DONE onmouseover -> display name popup
DONE Borders should be still visible when green/red contries
WONTDO possibility to display only PAs, hide conflicts

Ideas
Put PAs in the conflict box and onclick expand and show infos about PA
Circles for PAs: deacreasing radius over time
-->

<!doctype html>
<html>
<head>
    <style type="text/css">

        body{
            background-color: grey;
            font-family: "Verdana", sans-serif;
            color: rgb(10, 10, 10);
        }

        #container{
            position: relative;
            overflow: auto;
            width: 100%;
            height:100%;
        }

        #mapContainer{
            position: fixed;
            float: left;
            left: 0px;
            right: 0px;
            top: 0px;
            bottom: 0px;
            background-color: transparent;
            width: 75%;
            height: 100%;
        }
        #infoContainer{
            float: right;
            width: 24%;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        .infocell{
            margin: 10px;
            padding: 5px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.3);
            font-size: 13px;
        }

        #dateContainer{
            position: fixed;
            left: 8px;
            top: 8px;
            width: 7%;
            height:50px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            text-align:center;
            line-height: 50px;
            display:block;
            font-size: 16px;
        }

        #month{
            width: 30px;
            display: inline-block;
        }

        path {
            stroke: rgb(200, 200, 200);
            stroke-width: 0.5px;
        }

    </style>
    <script src="https://d3js.org/d3.v4.min.js"> </script>
</head>
<body>
    <div id='container'>
        <div id='infoContainer'></div>
        <div id='mapContainer'>
            <div id='dateContainer'>
                <span id='month'></span>
                <span id='year'></span>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">

    // ___________________________________________ GLOBAL VARIABLES ___________________________________________


    const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const PATH_TO_MAP = './data/countries.geo.json';
    const STEP_SIZE = 40; // represents the speed of the slider
    const START_DATE = new Date("1945-01-01");
    const END_DATE = new Date("2016-12-31");
    let current_date = START_DATE;
    let mapContainer = d3.select("#mapContainer");
    let countries;
    let conflicts = {}; // all conflicts, sorted by country id
    let conflicts_by_id = {}; // all conflicts, sorted by conflict id
    let width = mapContainer.node().clientWidth;
    let height = mapContainer.node().clientHeight;
    let margin = 8;


    // ___________________________________________ DOM ELEMENTS ___________________________________________


    d3.select('#infoContainer').style('height', height-margin*2+'px');


    // ___________________________________________ IMPORT DATA ___________________________________________

    // Loading the data
    d3.tsv("./data/conflicts.csv")
    .row(function(d) {
        var startdatesplit = d.startdate.split('-');
        var startdate = new Date(parseInt(startdatesplit[0]), parseInt(startdatesplit[1])-1, parseInt(startdatesplit[2]));
        var enddatesplit = d.enddate.split('-');
        var enddate = new Date(parseInt(enddatesplit[0]), parseInt(enddatesplit[1])-1, parseInt(enddatesplit[2]));
        // split locations, in case there are several locations for a single conflict
        d.locationID.split(',').forEach(function(loc_id){
            // create the dict entry if it does not exist yet
            if(!conflicts[loc_id]) conflicts[loc_id] = [];
            // push the data in the dict
            conflicts[loc_id].push({'start':startdate, 'end':enddate, 'country_name':d.location, 'conflict_id':d.conflictid, 'sidea':d.sidea, 'sideb':d.sideb});
        });

        conflicts_by_id[d.conflictid] = {'location':d.location, 'sidea':d.sidea, 'sideb':d.sideb};
    })
    .get(function(err, rows) {
        if (err) return console.error(err);
    });


    // ___________________________________________ MAP DISPLAY ___________________________________________


    let svg = mapContainer.append('svg')
        .attr('width', width)
        .attr('height', height);

    let mapLayer = svg.append('g');

    // projection of the world map
    var projection = d3.geoMercator().scale(width / 2 / Math.PI).translate([width/2, height/2+140]);
    
    d3.json(PATH_TO_MAP, function(err, geojson) {

        countries = mapLayer.selectAll("path")
        .data(geojson.features)
        .enter().append("path")
        .attr("d", d3.geoPath().projection(projection))
        .attr('id', country => country.id)
        .on('mouseover', function(d,i){
            d3.select(this).style('stroke', 'rgb(255, 255, 255)');
            d3.select(this).style('stroke-width', 2);
        })
        .on('mouseout', function(d, i){
            d3.select(this).style('stroke', 'rgb(200, 200, 200)');
            d3.select(this).style('stroke-width', 0.5);
        })
        .append('svg:title').text(function(d, i){return d.properties.name});
    });


    // ___________________________________________ UPDATE MAP ___________________________________________


    svg.node().addEventListener("mousewheel", function(e){
        update(e.wheelDelta < 0)
    }, false);


    // This function is called at each mouseWheelEvent
    // direction: true if scroll forward, false if backwards
    function update(direction){
        // update the current date
        updateDate(direction);
        // update the countries' colors
        printDate(current_date);
        let ongoingConflits = new Set();
        Object.keys(conflicts).forEach(function(cid){
            let status = getStatus(current_date, cid);
            let color = getColor(status.status, status.duration);
            mapLayer.select('path#'+cid).style('fill', color);
            status.ongoingConflits.forEach(conflict => ongoingConflits.add(conflict));
        });
        updateInfoPanel(Array.from(ongoingConflits));
    }


    // ___________________________________________ INFO PANEL ___________________________________________


    function updateInfoPanel(conflict_ids){
        let cells = d3.select('div#infoContainer').selectAll('.infocell').data(conflict_ids, cft_id => cft_id);
        
        cells.exit()
            .style('opacity', 1)
            .transition()
            .style('opacity', 0)
            .remove();
        
        cells.enter()
            .append('div')
            .classed('infocell', true)
            .html(d => conflictToString(d))
            .style('opacity', 0)
            .transition()
            .style('opacity', 1);

        //console.log("data size: " + conflict_ids.length)
        //console.log("DOM size: " + cells.size())
    }
    

    function conflictToString(c_id){
        let c = conflicts_by_id[c_id];
        return "ID: " + c_id + "<br/>Location: " + c.location + "<br/>" + "Side A:    " + c.sidea + "<br/>" + "Side B: " + c.sideb;
    }


    // ___________________________________________ DATE PANEL ___________________________________________


    // prints the input date in the date container
    function printDate(date){
        d3.select('#month').html(MONTH_NAMES[date.getMonth()]);
        d3.select('#year').html(date.getFullYear());
    }

    // This void function updates the global 'current_date' variable after a scrollEvent
    // direction: the scroll direction that defines if we go back or forward in time
    function updateDate(direction){
        // are we scrolling up or down?
        let step = direction ? STEP_SIZE : -STEP_SIZE;
        let new_date = d3.timeDay.offset(current_date, step);

        // clamp the date
        if(new_date < START_DATE){
            current_date = START_DATE;
        }
        else if(new_date > END_DATE){
            current_date = END_DATE;
        }
        else{
            current_date = new_date;
        }
    }


    // ___________________________________________ HELPER METHODS ___________________________________________


    // returns true if there is at least one conflict in the country, false otherwise
    function isInConflict(date, country){
        return conflicts[country].some(conflict => (date > conflict.start && date < conflict.end));
    }

    // input: a duration in ms
    // output: the same duration in days
    function msToDays(ms){
        return Math.round(ms/(1000*60*60*24));
    }

    // This function returns the status of the country at the given date
    // and for how long this status has been lasting
    // it also returns an array containing the ongoing conflicts
    // true: conflict, false: no conflict (i.e. peace)
    // country: country id
    function getStatus(current_date, country){
        let ongoingConflits = conflicts[country].filter(c => (current_date > c.start && current_date < c.end));
        let status, duration;

        // The country is at peace
        if(ongoingConflits.length == 0){
            status = false;
            let latestPeaceDay = d3.max([START_DATE, d3.max(conflicts[country].map(c => c.end).filter(end => end < current_date))]);
            duration = msToDays(current_date - latestPeaceDay);
        }
        // Only one conflict in the country at that time
        else if(ongoingConflits.length == 1){
            status = true;
            duration = msToDays(current_date - ongoingConflits[0].start);
        }
        // more than one conflict at that time
        else{
            status = true;
            duration = msToDays(current_date - d3.min(ongoingConflits, c => c.start));
        }
        return {'status': status, 'duration':duration, 'ongoingConflits':ongoingConflits.map(c => c.conflict_id)};
    }

    // returns the corresponding color (red for conflict, green for peace)
    // the duration determines the intensity (saturation) of the color
    // status: boolean indicating wether there is a conflict of not
    // duration: for how long has this status been lasting?
    function getColor(status, duration){
        let hue = status ? 360 : 100;
        let scale = d3.scaleLinear().domain([0, 5000]).range([0.3, 1]).clamp(true);
        let saturation = scale(duration);

        let color = d3.hsl(hue, saturation, 0.5);
        return color.rgb();
    }

</script>
</html>